---
import Layout from '../layouts/Layout.astro'
import { fetchArticles, fetchCourses, fetchEvents, fetchWebsiteHome } from '../lib/api'

const [home, articlesData, eventsData, coursesData] = await Promise.all([
  fetchWebsiteHome(),
  fetchArticles(),
  fetchEvents(),
  fetchCourses(),
])

const articles = articlesData.items ?? []
const events = eventsData.items ?? []
const courses = coursesData.items ?? []

const hero = (home.hero as { title: string; subtitle: string }) ?? {
  title: 'Terranova',
  subtitle: "Infrastructure numerique pour l'agroforesterie en Europe",
}

const featuredCounts = (home.featured_counts as {
  transformed_hectares: number
  active_labs: number
  citizen_contributors: number
}) ?? {
  transformed_hectares: 0,
  active_labs: 0,
  citizen_contributors: 0,
}
---

<Layout title="Terranova â€” Website">
  <main class="page">
    <section class="hero">
      <p class="eyebrow">API publique Rails + Front Astro</p>
      <h1>{hero.title}</h1>
      <p class="subtitle">{hero.subtitle}</p>
      <div class="metrics">
        <article>
          <strong>{featuredCounts.transformed_hectares}</strong>
          <span>hectares transformes</span>
        </article>
        <article>
          <strong>{featuredCounts.active_labs}</strong>
          <span>labs actifs</span>
        </article>
        <article>
          <strong>{featuredCounts.citizen_contributors}</strong>
          <span>contributeurs</span>
        </article>
      </div>
    </section>

    <section>
      <h2>Articles</h2>
      <ul class="grid-list">
        {articles.map((article) => (
          <li>
            <h3>{article.title}</h3>
            <p>{article.summary}</p>
            <small>{article.published_at}</small>
          </li>
        ))}
      </ul>
    </section>

    <section>
      <h2>Evenements</h2>
      <ul class="grid-list">
        {events.map((event) => (
          <li>
            <h3>{event.title}</h3>
            <p>{event.city}</p>
            <small>{event.starts_at}</small>
          </li>
        ))}
      </ul>
    </section>

    <section>
      <h2>Formations</h2>
      <ul class="grid-list">
        {courses.map((course) => (
          <li>
            <h3>{course.title}</h3>
            <p>Niveau: {course.level}</p>
            <small>{course.duration_days} jours</small>
          </li>
        ))}
      </ul>
    </section>
  </main>
</Layout>
